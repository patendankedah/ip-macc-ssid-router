<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IP – MAC – SSID – ROUTER</title>
  <style>
    :root {
      --border: #d1d5db;
      --text: #111827;
      --muted: #6b7280;
      --bg: #f3f4f6;
      --primary: #2563eb;
      --danger: #b91c1c;
      --success: #15803d;
      --warn: #92400e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #ffffff;
      color: var(--text);
      padding: 16px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      text-align: left;
    }
    th {
      background: var(--bg);
      font-weight: 600;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .refresh-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
      color: var(--text);
      white-space: nowrap;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .form-group {
      margin-bottom: 8px;
    }
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--muted);
    }
    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }
    input[readonly] {
      background: var(--bg);
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .btn {
      width: 100%;
      border: none;
      border-radius: 4px;
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
      margin-top: 4px;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      margin-top: 6px;
      padding: 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      display: none;
    }
    .status.ok {
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      color: var(--success);
    }
    .status.err {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: var(--danger);
    }
    .status.warn {
      background: #fef3c7;
      border: 1px solid #fde68a;
      color: var(--warn);
    }
    .status.info {
      background: #e0f2fe;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }
    @media (max-width: 640px) {
      .form-row { grid-template-columns: 1fr; }
      .top-row { flex-direction: column; align-items: flex-start; }
      .refresh-btn { align-self: flex-end; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div style="margin-bottom:12px;">
      <h1>Manajemen IP – MAC – SSID – ROUTER</h1>
      <p class="subtitle">Baca baris terakhir dari Google Sheet dan input data baru dengan auto-increment IP & SSID.</p>
    </div>

    <!-- DATA TERAKHIR -->
    <div class="card">
      <div class="top-row">
        <div>
          <h2 style="font-size:1rem;">Data Terakhir</h2>
          <p class="subtitle" style="margin-bottom:0;">Menampilkan baris paling akhir dari sheet.</p>
        </div>
        <button type="button" id="refreshBtn" class="refresh-btn">Refresh Data</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>IP</th>
            <th>MACC</th>
            <th>SSID</th>
            <th>ROUTER</th>
          </tr>
        </thead>
        <tbody id="dataBody">
          <tr>
            <td colspan="4" style="text-align:center;">Memuat data...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- FORM INPUT -->
    <div class="card">
      <h2 style="font-size:1rem; margin-bottom:6px;">Input Data Baru</h2>
      <p class="subtitle" style="margin-bottom:8px;">IP & SSID diisi otomatis. Lengkapi MACC dan ROUTER.</p>

      <form id="dataForm">
        <div class="form-row">
          <div class="form-group">
            <label for="IP">IP Address (auto)</label>
            <input type="text" id="IP" name="IP" readonly placeholder="Diisi otomatis">
          </div>
          <div class="form-group">
            <label for="MACC">MAC Address</label>
            <input type="text" id="MACC" name="MACC" placeholder="AA:BB:CC:DD:EE:FF" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="SSID">SSID (auto)</label>
            <input type="text" id="SSID" name="SSID" readonly placeholder="Diisi otomatis">
          </div>
          <div class="form-group">
            <label for="ROUTER">ROUTER</label>
            <input type="text" id="ROUTER" name="ROUTER" placeholder="Nama router" required>
          </div>
        </div>

        <button type="submit" class="btn" id="submitBtn">Kirim</button>
      </form>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const API_URL  = 'https://script.google.com/macros/s/AKfycbyvXCS1Jqqeydvb5lj3UA5f5xzGbLg5nIwVDxV1KQe_MO1N9YkRAfVnBOo1A3I2wwn5/exec';
    const IP_PREFIX = '192.168.200.';
    const IP_MAX    = 253;

    const dataBody   = document.getElementById('dataBody');
    const form       = document.getElementById('dataForm');
    const statusEl   = document.getElementById('status');
    const ipInput    = document.getElementById('IP');
    const ssidInput  = document.getElementById('SSID');
    const submitBtn  = document.getElementById('submitBtn');
    const maccInput  = document.getElementById('MACC');
    const refreshBtn = document.getElementById('refreshBtn');

    let isLoading = false;

    function showStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + type;
      statusEl.style.display = 'block';
    }

    function incrementIP(ipString) {
      try {
        const parts = ipString.split('.');
        if (parts.length !== 4) return null;
        let last = parseInt(parts[3], 10);
        last++;
        if (last > IP_MAX) return null;
        return IP_PREFIX + last;
      } catch {
        return null;
      }
    }

    // SSID auto-increment: "P.GEMILANG 2" -> "P.GEMILANG 3"
    function incrementSSID(ssidString, nextIPNumber) {
      try {
        const match = ssidString.match(/^(.+?)\s*(\d+)$/);
        if (match) {
          const prefix = match[1].trim();
          const lastNum = parseInt(match[2], 10);
          const newNum = lastNum + 1;
          return prefix + ' ' + newNum;
        }
        const prefixOnly = (ssidString || '').trim();
        if (!prefixOnly) return 'SSID ' + nextIPNumber;
        return prefixOnly + ' ' + nextIPNumber;
      } catch {
        return ssidString;
      }
    }

    // Format MAC: auto tambah ":" setiap 2 karakter hex
    function formatMac(value) {
      let v = value.toUpperCase().replace(/[^0-9A-F]/g, '');
      v = v.slice(0, 12);
      const parts = v.match(/.{1,2}/g) || [];
      return parts.join(':');
    }

    // Format MAC saat user mengetik
    maccInput.addEventListener('input', () => {
      const formatted = formatMac(maccInput.value);
      maccInput.value = formatted;
      maccInput.selectionStart = maccInput.selectionEnd = formatted.length;
    });

    async function loadData() {
      try {
        dataBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';

        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const json = await res.json();
        const allData = Array.isArray(json) ? json : [];

        if (allData.length === 0) {
          dataBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data.</td></tr>';
          ipInput.value = '';
          ssidInput.value = '';
          return;
        }

        const lastData = allData[allData.length - 1];

        dataBody.innerHTML = `
          <tr>
            <td>${lastData.IP || '-'}</td>
            <td>${lastData.MACC || '-'}</td>
            <td>${lastData.SSID || '-'}</td>
            <td>${lastData.ROUTER || '-'}</td>
          </tr>
        `;

        const lastIP   = lastData.IP   || '';
        const lastSSID = lastData.SSID || '';
        const nextIP   = incrementIP(lastIP);

        if (nextIP) {
          const nextNum = parseInt(nextIP.split('.')[3], 10);
          ipInput.value   = nextIP;
          ssidInput.value = incrementSSID(lastSSID, nextNum);
          submitBtn.disabled = false;
        } else {
          ipInput.value   = lastIP;
          ssidInput.value = lastSSID;
          submitBtn.disabled = true;
          showStatus('IP sudah mencapai maksimal (' + IP_MAX + ').', 'warn');
        }
      } catch (err) {
        dataBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:#b91c1c;">
              Gagal memuat data: ${err.message}
            </td>
          </tr>`;
      }
    }

    // Tombol manual refresh
    refreshBtn.addEventListener('click', () => {
      loadData();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isLoading) return;
      isLoading = true;
      submitBtn.disabled = true;

      showStatus('Mengirim data...', 'info');

      const IP     = ipInput.value.trim();
      const MACC   = maccInput.value.trim();
      const SSID   = ssidInput.value.trim();
      const ROUTER = form.ROUTER.value.trim();

      if (!IP || !MACC || !SSID || !ROUTER) {
        showStatus('Semua field wajib diisi.', 'err');
        isLoading = false;
        submitBtn.disabled = false;
        return;
      }

      try {
        const body = new URLSearchParams();
        body.append('IP', IP);
        body.append('MACC', MACC);
        body.append('SSID', SSID);
        body.append('ROUTER', ROUTER);

        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body
        });

        showStatus('Data dikirim. Cek Google Sheet untuk memastikan tersimpan.', 'ok');

        maccInput.value   = '';
        form.ROUTER.value = '';

        // Refresh otomatis setelah kirim
        setTimeout(loadData, 1000);
      } catch (err) {
        showStatus('Gagal mengirim data: ' + err.message, 'err');
      } finally {
        isLoading = false;
        submitBtn.disabled = false;
      }
    });

    // Hanya load sekali saat pertama kali dibuka
    loadData();
  </script>
</body>
</html>
